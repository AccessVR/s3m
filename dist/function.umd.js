!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e||self).s3m=n()}(this,function(){var e=/*#__PURE__*/function(){function e(n,t){void 0===t&&(t={}),this.file=n,this.options=t,this.chunkSize=t.chunk_size||e.DEFAULT_CHUNK_SIZE,this.maxConcurrentUploads=t.max_concurrent_uploads||e.DEFAULT_MAX_CONCURRENT_UPLOADS,this.fileName=n.name,this.fileSize=n.size,this.fileType=n.type}var o=e.prototype;return o.startUpload=function(){try{var e=this;if(!e.fileName)throw new Error("Filename is empty");return Promise.resolve(axios.get("/s3m/create-multipart-upload",{params:{filename:e.fileName,content_type:e.fileType}})).then(function(e){return e.data})}catch(e){return Promise.reject(e)}},o.upload=function(){try{var e=this;return Promise.resolve(function(n,t){try{var r=Promise.resolve(e.startUpload(e.file)).then(function(n){var t=n.key,r=n.uploadId,o=n.uuid;if(r){var i=e.options.progress||function(){};return Promise.resolve(e.uploadChunks(t,r,i)).then(function(n){return Promise.resolve(e.completeUpload(t,r,n)).then(function(n){return i(100),{uuid:o,key:t,extension:e.fileName.split(".").pop(),name:e.fileName,url:n}})})}console.error("Upload ID not found")})}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}(0,function(e){console.error(e)}))}catch(e){return Promise.reject(e)}},o.uploadChunks=function(e,o,i){try{var u=this,a=Math.ceil(u.fileSize/u.chunkSize),s=new Array(a).fill(0),c=[],f=0,l=0,h=Array.from({length:u.maxConcurrentUploads}).map(function n(){try{if(l>=a)return Promise.resolve();var t=l*u.chunkSize,r=Math.min(t+u.chunkSize,u.fileSize),h=u.file.slice(t,r);return f++,l++,Promise.resolve(u.uploadChunk(e,o,l,h,a,s,i)).then(function(e){c.push(e),--f<u.maxConcurrentUploads&&n()})}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(h)).then(function(){function e(){return c.sort(function(e,n){return e.PartNumber-n.PartNumber})}var o=function(e,o,i){for(var u;;){var a=e();if(r(a)&&(a=a.v),!a)return s;if(a.then){u=0;break}var s=i();if(s&&s.then){if(!r(s)){u=1;break}s=s.s}if(o){var c=o();if(c&&c.then&&!r(c)){u=2;break}}}var f=new t,l=n.bind(null,f,2);return(0===u?a.then(d):1===u?s.then(h):c.then(p)).then(void 0,l),f;function h(t){s=t;do{if(o&&(c=o())&&c.then&&!r(c))return void c.then(p).then(void 0,l);if(!(a=e())||r(a)&&!a.v)return void n(f,1,s);if(a.then)return void a.then(d).then(void 0,l);r(s=i())&&(s=s.v)}while(!s||!s.then);s.then(h).then(void 0,l)}function d(e){e?(s=i())&&s.then?s.then(h).then(void 0,l):h(s):n(f,1,s)}function p(){(a=e())?a.then?a.then(d).then(void 0,l):d(a):n(f,1,s)}}(function(){return f>0},void 0,function(){return Promise.resolve(new Promise(function(e){return setTimeout(e,100)})).then(function(){})});return o&&o.then?o.then(e):e()})}catch(e){return Promise.reject(e)}},o.completeUpload=function(e,n,t){try{return Promise.resolve(axios.post("/s3m/complete-multipart-upload",{parts:t,upload_id:n,key:e})).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},o.getSignUrl=function(e,n,t){try{return Promise.resolve(axios.get("/s3m/create-sign-part",{params:{filename:this.fileName,content_type:this.fileType,part_number:t,upload_id:n,key:e}})).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},o.uploadChunk=function(e,n,t,r,o,i,u){try{var a=this;return Promise.resolve(a.getSignUrl(e,n,t)).then(function(e){return Promise.resolve(axios.put(e,r,{headers:{"Content-Type":a.fileType},onUploadProgress:function(e){return a.handleUploadProgress(e,o,t-1,i,u)}})).then(function(e){return{ETag:e.headers.etag,PartNumber:t}})})}catch(e){return Promise.reject(e)}},o.handleUploadProgress=function(e,n,t,r,o){var i=Math.round(100*e.loaded/e.total);r[t]=i,o(Math.round(r.reduce(function(e,n){return e+n})/n))},e}();function n(e,r,o){if(!e.s){if(o instanceof t){if(!o.s)return void(o.o=n.bind(null,e,r));1&r&&(r=o.s),o=o.v}if(o&&o.then)return void o.then(n.bind(null,e,r),n.bind(null,e,2));e.s=r,e.v=o;const i=e.o;i&&i(e)}}var t=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){var o=new e,i=this.s;if(i){var u=1&i?t:r;if(u){try{n(o,1,u(this.v))}catch(e){n(o,2,e)}return o}return this}return this.o=function(e){try{var i=e.v;1&e.s?n(o,1,t?t(i):i):r?n(o,1,r(i)):n(o,2,i)}catch(e){n(o,2,e)}},o},e}();function r(e){return e instanceof t&&1&e.s}return e.DEFAULT_CHUNK_SIZE=10485760,e.DEFAULT_MAX_CONCURRENT_UPLOADS=5,function(n,t){return new e(n,t).upload()}});
