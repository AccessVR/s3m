!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e||self).route=t()}(this,function(){var e=/*#__PURE__*/function(){function e(e,t){void 0===t&&(t={}),this.file=e,this.options=t}var o=e.prototype;return o.upload=function(){try{var e=this;return Promise.resolve(function(t,n){try{var r=Promise.resolve(e.startUpload(e.file)).then(function(t){var n=t.key,r=t.uploadId,o=t.uuid;if(r){var i=e.options.progress||function(){};return Promise.resolve(e.uploadChunks(e.file,n,r,i)).then(function(t){return Promise.resolve(e.completeUpload(n,r,t)).then(function(t){return i(100),{uuid:o,key:n,extension:e.file.name.split(".").pop(),name:e.file.name,url:t}})})}console.error("Upload ID not found")})}catch(e){return n(e)}return r&&r.then?r.then(void 0,n):r}(0,function(e){console.error(e)}))}catch(e){return Promise.reject(e)}},o.startUpload=function(e){try{var t=e.name,n=e.type;if(!t)throw new Error("Filename is empty");return Promise.resolve(axios.get(route("storage.create.multipart"),{params:{filename:t,content_type:n}})).then(function(e){return e.data})}catch(e){return Promise.reject(e)}},o.uploadFilePart=function(e,t,n,r){try{return Promise.resolve(axios.get(route("storage.create.sign-part"),{params:{filename:e.name,content_type:e.type,part_number:r,upload_id:n,key:t}})).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},o.uploadChunk=function(e,t,n,r,o,i,u,a){try{var s=this;return Promise.resolve(s.uploadFilePart(e,t,n,r)).then(function(t){return Promise.resolve(axios.put(t,o,{headers:{"Content-Type":e.type},onUploadProgress:function(e){return s.handleUploadProgress(e,i,r-1,u,a)}})).then(function(e){return{ETag:e.headers.etag,PartNumber:r}})})}catch(e){return Promise.reject(e)}},o.handleUploadProgress=function(e,t,n,r,o){var i=Math.round(100*e.loaded/e.total);r[n]=i,o(Math.round(r.reduce(function(e,t){return e+t})/t))},o.uploadChunks=function(e,o,i,u){try{var a=this,s=ManyRequestsFilesystem.CHUNK_SIZE,c=Math.ceil(e.size/s),f=new Array(c).fill(0),l=[],h=0,d=0,p=Array.from({length:ManyRequestsFilesystem.MAX_CONCURRENT_UPLOADS}).map(function t(){try{if(d>=c)return Promise.resolve();var n=d*s,r=Math.min(n+s,e.size),p=e.slice(n,r);return h++,d++,Promise.resolve(a.uploadChunk(e,o,i,d,p,c,f,u)).then(function(e){l.push(e),--h<ManyRequestsFilesystem.MAX_CONCURRENT_UPLOADS&&t()})}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(p)).then(function(){function e(){return l.sort(function(e,t){return e.PartNumber-t.PartNumber})}var o=function(e,o,i){for(var u;;){var a=e();if(r(a)&&(a=a.v),!a)return s;if(a.then){u=0;break}var s=i();if(s&&s.then){if(!r(s)){u=1;break}s=s.s}if(o){var c=o();if(c&&c.then&&!r(c)){u=2;break}}}var f=new n,l=t.bind(null,f,2);return(0===u?a.then(d):1===u?s.then(h):c.then(p)).then(void 0,l),f;function h(n){s=n;do{if(o&&(c=o())&&c.then&&!r(c))return void c.then(p).then(void 0,l);if(!(a=e())||r(a)&&!a.v)return void t(f,1,s);if(a.then)return void a.then(d).then(void 0,l);r(s=i())&&(s=s.v)}while(!s||!s.then);s.then(h).then(void 0,l)}function d(e){e?(s=i())&&s.then?s.then(h).then(void 0,l):h(s):t(f,1,s)}function p(){(a=e())?a.then?a.then(d).then(void 0,l):d(a):t(f,1,s)}}(function(){return h>0},void 0,function(){return console.log({activeUploads:h}),Promise.resolve(new Promise(function(e){return setTimeout(e,100)})).then(function(){})});return o&&o.then?o.then(e):e()})}catch(e){return Promise.reject(e)}},o.completeUpload=function(e,t,n){try{return Promise.resolve(axios.post(route("storage.create.multipart-complete"),{parts:n,upload_id:t,key:e})).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},e}();function t(e,r,o){if(!e.s){if(o instanceof n){if(!o.s)return void(o.o=t.bind(null,e,r));1&r&&(r=o.s),o=o.v}if(o&&o.then)return void o.then(t.bind(null,e,r),t.bind(null,e,2));e.s=r,e.v=o;const i=e.o;i&&i(e)}}var n=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(n,r){var o=new e,i=this.s;if(i){var u=1&i?n:r;if(u){try{t(o,1,u(this.v))}catch(e){t(o,2,e)}return o}return this}return this.o=function(e){try{var i=e.v;1&e.s?t(o,1,n?n(i):i):r?t(o,1,r(i)):t(o,2,i)}catch(e){t(o,2,e)}},o},e}();function r(e){return e instanceof n&&1&e.s}return e.CHUNK_SIZE=10485760,e.MAX_CONCURRENT_UPLOADS=5,function(t,n){return new e(t,n).upload()}});
