!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e||self).s3m=n()}(this,function(){var e=/*#__PURE__*/function(){function e(e,n){void 0===n&&(n={}),this.file=e,this.options=n}var o=e.prototype;return o.startUpload=function(e){try{var n=e.name,t=e.type;if(!n)throw new Error("Filename is empty");return Promise.resolve(axios.get("/s3m/create-multipart-upload",{params:{filename:n,content_type:t}})).then(function(e){return e.data})}catch(e){return Promise.reject(e)}},o.upload=function(){try{var e=this;return Promise.resolve(function(n,t){try{var r=Promise.resolve(e.startUpload(e.file)).then(function(n){var t=n.key,r=n.uploadId,o=n.uuid;if(r){var i=e.options.progress||function(){};return Promise.resolve(e.uploadChunks(e.file,t,r,i)).then(function(n){return Promise.resolve(e.completeUpload(t,r,n)).then(function(n){return i(100),{uuid:o,key:t,extension:e.file.name.split(".").pop(),name:e.file.name,url:n}})})}console.error("Upload ID not found")})}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}(0,function(e){console.error(e)}))}catch(e){return Promise.reject(e)}},o.uploadChunks=function(o,i,u,a){try{var s=this,c=s.options.chunk_size||e.DEFAULT_CHUNK_SIZE,f=s.options.max_concurrent_uploads||e.DEFAULT_MAX_CONCURRENT_UPLOADS,l=Math.ceil(o.size/c),h=new Array(l).fill(0),d=[],p=0,v=0,m=Array.from({length:f}).map(function e(){try{if(v>=l)return Promise.resolve();var n=v*c,t=Math.min(n+c,o.size),r=o.slice(n,t);return p++,v++,Promise.resolve(s.uploadChunk(o,i,u,v,r,l,h,a)).then(function(n){d.push(n),--p<f&&e()})}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(m)).then(function(){function e(){return d.sort(function(e,n){return e.PartNumber-n.PartNumber})}var o=function(e,o,i){for(var u;;){var a=e();if(r(a)&&(a=a.v),!a)return s;if(a.then){u=0;break}var s=i();if(s&&s.then){if(!r(s)){u=1;break}s=s.s}if(o){var c=o();if(c&&c.then&&!r(c)){u=2;break}}}var f=new t,l=n.bind(null,f,2);return(0===u?a.then(d):1===u?s.then(h):c.then(p)).then(void 0,l),f;function h(t){s=t;do{if(o&&(c=o())&&c.then&&!r(c))return void c.then(p).then(void 0,l);if(!(a=e())||r(a)&&!a.v)return void n(f,1,s);if(a.then)return void a.then(d).then(void 0,l);r(s=i())&&(s=s.v)}while(!s||!s.then);s.then(h).then(void 0,l)}function d(e){e?(s=i())&&s.then?s.then(h).then(void 0,l):h(s):n(f,1,s)}function p(){(a=e())?a.then?a.then(d).then(void 0,l):d(a):n(f,1,s)}}(function(){return p>0},void 0,function(){return console.log({activeUploads:p}),Promise.resolve(new Promise(function(e){return setTimeout(e,100)})).then(function(){})});return o&&o.then?o.then(e):e()})}catch(e){return Promise.reject(e)}},o.completeUpload=function(e,n,t){try{return Promise.resolve(axios.post("/s3m/complete-multipart-upload",{parts:t,upload_id:n,key:e})).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},o.getSignUrl=function(e,n,t,r){try{return Promise.resolve(axios.get("/s3m/create-sign-part",{params:{filename:e.name,content_type:e.type,part_number:r,upload_id:t,key:n}})).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},o.uploadChunk=function(e,n,t,r,o,i,u,a){try{var s=this;return Promise.resolve(s.getSignUrl(e,n,t,r)).then(function(n){return Promise.resolve(axios.put(n,o,{headers:{"Content-Type":e.type},onUploadProgress:function(e){return s.handleUploadProgress(e,i,r-1,u,a)}})).then(function(e){return{ETag:e.headers.etag,PartNumber:r}})})}catch(e){return Promise.reject(e)}},o.handleUploadProgress=function(e,n,t,r,o){var i=Math.round(100*e.loaded/e.total);r[t]=i,o(Math.round(r.reduce(function(e,n){return e+n})/n))},e}();function n(e,r,o){if(!e.s){if(o instanceof t){if(!o.s)return void(o.o=n.bind(null,e,r));1&r&&(r=o.s),o=o.v}if(o&&o.then)return void o.then(n.bind(null,e,r),n.bind(null,e,2));e.s=r,e.v=o;const i=e.o;i&&i(e)}}var t=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){var o=new e,i=this.s;if(i){var u=1&i?t:r;if(u){try{n(o,1,u(this.v))}catch(e){n(o,2,e)}return o}return this}return this.o=function(e){try{var i=e.v;1&e.s?n(o,1,t?t(i):i):r?n(o,1,r(i)):n(o,2,i)}catch(e){n(o,2,e)}},o},e}();function r(e){return e instanceof t&&1&e.s}return e.DEFAULT_CHUNK_SIZE=10485760,e.DEFAULT_MAX_CONCURRENT_UPLOADS=5,function(n,t){return new e(n,t).upload()}});
