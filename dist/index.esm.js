var e=/*#__PURE__*/function(){function e(t,n){void 0===n&&(n={}),this.file=t,this.options=n,this.chunkSize=n.chunk_size||e.DEFAULT_CHUNK_SIZE,this.maxConcurrentUploads=n.max_concurrent_uploads||e.DEFAULT_MAX_CONCURRENT_UPLOADS,this.fileName=t.name,this.fileSize=t.size,this.fileType=t.type}var i=e.prototype;return i.startUpload=function(){try{var e=this;if(!e.fileName)throw new Error("Filename is empty");return Promise.resolve(axios.get("/s3m/create-multipart-upload",{params:{filename:e.fileName,content_type:e.fileType}})).then(function(e){return e.data})}catch(e){return Promise.reject(e)}},i.upload=function(){try{var e=this;return Promise.resolve(function(t,n){try{var r=Promise.resolve(e.startUpload(e.file)).then(function(t){var n=t.key,r=t.uploadId,i=t.uuid;if(r){var o=e.options.progress||function(){};return Promise.resolve(e.uploadChunks(n,r,o)).then(function(t){return Promise.resolve(e.completeUpload(n,r,t)).then(function(t){return o(100),{uuid:i,key:n,extension:e.fileName.split(".").pop(),name:e.fileName,url:t}})})}console.error("Upload ID not found")})}catch(e){return n(e)}return r&&r.then?r.then(void 0,n):r}(0,function(e){console.error(e)}))}catch(e){return Promise.reject(e)}},i.uploadChunks=function(e,i,o){try{var u=this,a=Math.ceil(u.fileSize/u.chunkSize),s=new Array(a).fill(0),c=[],h=0,l=0,f=Array.from({length:u.maxConcurrentUploads}).map(function t(){try{if(l>=a)return Promise.resolve();var n=l*u.chunkSize,r=Math.min(n+u.chunkSize,u.fileSize),f=u.file.slice(n,r);return h++,l++,Promise.resolve(u.uploadChunk(e,i,l,f,a,s,o)).then(function(e){c.push(e),--h<u.maxConcurrentUploads&&t()})}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(f)).then(function(){function e(){return c.sort(function(e,t){return e.PartNumber-t.PartNumber})}var i=function(e,i,o){for(var u;;){var a=e();if(r(a)&&(a=a.v),!a)return s;if(a.then){u=0;break}var s=o();if(s&&s.then){if(!r(s)){u=1;break}s=s.s}if(i){var c=i();if(c&&c.then&&!r(c)){u=2;break}}}var h=new n,l=t.bind(null,h,2);return(0===u?a.then(d):1===u?s.then(f):c.then(p)).then(void 0,l),h;function f(n){s=n;do{if(i&&(c=i())&&c.then&&!r(c))return void c.then(p).then(void 0,l);if(!(a=e())||r(a)&&!a.v)return void t(h,1,s);if(a.then)return void a.then(d).then(void 0,l);r(s=o())&&(s=s.v)}while(!s||!s.then);s.then(f).then(void 0,l)}function d(e){e?(s=o())&&s.then?s.then(f).then(void 0,l):f(s):t(h,1,s)}function p(){(a=e())?a.then?a.then(d).then(void 0,l):d(a):t(h,1,s)}}(function(){return h>0},void 0,function(){return Promise.resolve(new Promise(function(e){return setTimeout(e,100)})).then(function(){})});return i&&i.then?i.then(e):e()})}catch(e){return Promise.reject(e)}},i.completeUpload=function(e,t,n){try{return Promise.resolve(axios.post("/s3m/complete-multipart-upload",{parts:n,upload_id:t,key:e})).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},i.getSignUrl=function(e,t,n){try{return Promise.resolve(axios.get("/s3m/create-sign-part",{params:{filename:this.fileName,content_type:this.fileType,part_number:n,upload_id:t,key:e}})).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},i.uploadChunk=function(e,t,n,r,i,o,u){try{var a=this;return Promise.resolve(a.getSignUrl(e,t,n)).then(function(e){return Promise.resolve(axios.put(e,r,{headers:{"Content-Type":a.fileType},onUploadProgress:function(e){return a.handleUploadProgress(e,i,n-1,o,u)}})).then(function(e){return{ETag:e.headers.etag,PartNumber:n}})})}catch(e){return Promise.reject(e)}},i.handleUploadProgress=function(e,t,n,r,i){var o=Math.round(100*e.loaded/e.total);r[n]=o,i(Math.round(r.reduce(function(e,t){return e+t})/t))},e}();function t(e,r,i){if(!e.s){if(i instanceof n){if(!i.s)return void(i.o=t.bind(null,e,r));1&r&&(r=i.s),i=i.v}if(i&&i.then)return void i.then(t.bind(null,e,r),t.bind(null,e,2));e.s=r,e.v=i;const o=e.o;o&&o(e)}}var n=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(n,r){var i=new e,o=this.s;if(o){var u=1&o?n:r;if(u){try{t(i,1,u(this.v))}catch(e){t(i,2,e)}return i}return this}return this.o=function(e){try{var o=e.v;1&e.s?t(i,1,n?n(o):o):r?t(i,1,r(o)):t(i,2,o)}catch(e){t(i,2,e)}},i},e}();function r(e){return e instanceof n&&1&e.s}function i(t,n){return new e(t,n).upload()}e.DEFAULT_CHUNK_SIZE=10485760,e.DEFAULT_MAX_CONCURRENT_UPLOADS=5;export{i as s3m};
