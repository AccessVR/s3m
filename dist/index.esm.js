var e=/*#__PURE__*/function(){function e(e,t){void 0===t&&(t={}),this.file=e,this.options=t}var o=e.prototype;return o.upload=function(){try{var e=this;return Promise.resolve(function(t,r){try{var n=Promise.resolve(e.startUpload(e.file)).then(function(t){var r=t.key,n=t.uploadId,o=t.uuid;if(n){var i=e.options.progress||function(){};return Promise.resolve(e.uploadChunks(e.file,r,n,i)).then(function(t){return Promise.resolve(e.completeUpload(r,n,t)).then(function(t){return i(100),{uuid:o,key:r,extension:e.file.name.split(".").pop(),name:e.file.name,url:t}})})}console.error("Upload ID not found")})}catch(e){return r(e)}return n&&n.then?n.then(void 0,r):n}(0,function(e){console.error(e)}))}catch(e){return Promise.reject(e)}},o.startUpload=function(e){try{var t=e.name,r=e.type;if(!t)throw new Error("Filename is empty");return Promise.resolve(axios.get(route("storage.create.multipart"),{params:{filename:t,content_type:r}})).then(function(e){return e.data})}catch(e){return Promise.reject(e)}},o.uploadFilePart=function(e,t,r,n){try{return Promise.resolve(axios.get(route("storage.create.sign-part"),{params:{filename:e.name,content_type:e.type,part_number:n,upload_id:r,key:t}})).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},o.uploadChunk=function(e,t,r,n,o,i,u,a){try{var s=this;return Promise.resolve(s.uploadFilePart(e,t,r,n)).then(function(t){return Promise.resolve(axios.put(t,o,{headers:{"Content-Type":e.type},onUploadProgress:function(e){return s.handleUploadProgress(e,i,n-1,u,a)}})).then(function(e){return{ETag:e.headers.etag,PartNumber:n}})})}catch(e){return Promise.reject(e)}},o.handleUploadProgress=function(e,t,r,n,o){var i=Math.round(100*e.loaded/e.total);n[r]=i,o(Math.round(n.reduce(function(e,t){return e+t})/t))},o.uploadChunks=function(e,o,i,u){try{var a=this,s=ManyRequestsFilesystem.CHUNK_SIZE,c=Math.ceil(e.size/s),l=new Array(c).fill(0),h=[],f=0,d=0,v=Array.from({length:ManyRequestsFilesystem.MAX_CONCURRENT_UPLOADS}).map(function t(){try{if(d>=c)return Promise.resolve();var r=d*s,n=Math.min(r+s,e.size),v=e.slice(r,n);return f++,d++,Promise.resolve(a.uploadChunk(e,o,i,d,v,c,l,u)).then(function(e){h.push(e),--f<ManyRequestsFilesystem.MAX_CONCURRENT_UPLOADS&&t()})}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(v)).then(function(){function e(){return h.sort(function(e,t){return e.PartNumber-t.PartNumber})}var o=function(e,o,i){for(var u;;){var a=e();if(n(a)&&(a=a.v),!a)return s;if(a.then){u=0;break}var s=i();if(s&&s.then){if(!n(s)){u=1;break}s=s.s}if(o){var c=o();if(c&&c.then&&!n(c)){u=2;break}}}var l=new r,h=t.bind(null,l,2);return(0===u?a.then(d):1===u?s.then(f):c.then(v)).then(void 0,h),l;function f(r){s=r;do{if(o&&(c=o())&&c.then&&!n(c))return void c.then(v).then(void 0,h);if(!(a=e())||n(a)&&!a.v)return void t(l,1,s);if(a.then)return void a.then(d).then(void 0,h);n(s=i())&&(s=s.v)}while(!s||!s.then);s.then(f).then(void 0,h)}function d(e){e?(s=i())&&s.then?s.then(f).then(void 0,h):f(s):t(l,1,s)}function v(){(a=e())?a.then?a.then(d).then(void 0,h):d(a):t(l,1,s)}}(function(){return f>0},void 0,function(){return console.log({activeUploads:f}),Promise.resolve(new Promise(function(e){return setTimeout(e,100)})).then(function(){})});return o&&o.then?o.then(e):e()})}catch(e){return Promise.reject(e)}},o.completeUpload=function(e,t,r){try{return Promise.resolve(axios.post(route("storage.create.multipart-complete"),{parts:r,upload_id:t,key:e})).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},e}();function t(e,n,o){if(!e.s){if(o instanceof r){if(!o.s)return void(o.o=t.bind(null,e,n));1&n&&(n=o.s),o=o.v}if(o&&o.then)return void o.then(t.bind(null,e,n),t.bind(null,e,2));e.s=n,e.v=o;const i=e.o;i&&i(e)}}var r=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(r,n){var o=new e,i=this.s;if(i){var u=1&i?r:n;if(u){try{t(o,1,u(this.v))}catch(e){t(o,2,e)}return o}return this}return this.o=function(e){try{var i=e.v;1&e.s?t(o,1,r?r(i):i):n?t(o,1,n(i)):t(o,2,i)}catch(e){t(o,2,e)}},o},e}();function n(e){return e instanceof r&&1&e.s}function o(t,r){return new e(t,r).upload()}e.CHUNK_SIZE=10485760,e.MAX_CONCURRENT_UPLOADS=5;export{o as s3m};
